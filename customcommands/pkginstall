#!/usr/bin/env bash

# Shebang only accept one argument.
#    #!/usr/bin/env bash -e
# wouldn't worked
set -e 

PKG_DIR="$HOME/.pkgs"

mkdir -p "$PKG_DIR"

case $1 in
    rust|cargo)
        DEST="$PKG_DIR/rust/"
        export RUSTUP_HOME="$DEST/rustup"
        export RUSTUP_PREFIX="$DEST"
        export CARGO_HOME="$DEST/cargo"
        mkdir -p "$DEST"
        curl https://static.rust-lang.org/rustup.sh | bash -s -- --disable-sudo --disable-ldconfig
        ;;
    ocaml|opam)
        DEST="$PKG_DIR/ocaml/"
        mkdir -p "$DEST"
        curl https://raw.githubusercontent.com/hcarty/ocamlbrew/master/ocamlbrew-install | env OCAMLBREW_FLAGS="-r -b $DEST" bash
        ;;
    ruby|rails|rvm)
        DEST="$PKG_DIR/rvm"
        curl -sSL https://get.rvm.io | bash -s -- --ignore-dotfiles --path "$DEST" --user-install stable
        ;;
    otp|erlang|rebar)
        DEST="$PKG_DIR/erlang/"
        mkdir "$DEST"
        # Install erlang itself
        (
            set -e
            cd $(mktemp -d)
            SHA1="4397f29801fd430ef7e9ff03ea814807bf954e20"
            CACHE="/tmp/${SHA1}.tar.gz"
            test -f "$CACHE" || curl -L "http://erlang.org/download/otp_src_18.2.1.tar.gz" -o "$CACHE"
            echo "${SHA1}  $CACHE" | sha1sum -c
            tar -x --strip-components=1 -f "$CACHE"
            ./configure --prefix="$DEST"
            make -j4 all install
        )
        # Install rebar
        (
            set -e
            export PATH="$DEST/bin/:$PATH"
            cd $(mktemp -d)
            curl -L "https://github.com/rebar/rebar/archive/2.6.1.tar.gz" -o rebar.tar.gz
            echo "7f9b799c5dfa06d1779d828c767be2732dacc411  rebar.tar.gz" | sha1sum -c
            tar -x --strip-components=1 -f rebar.tar.gz
            ./bootstrap
            mv ./rebar "$DEST/bin/"
        )
        ;;
    npm|node)
        DEST="$PKG_DIR/node"
        mkdir "$DEST"
        (
            set -e
            cd $(mktemp -d)
            SHA256="0bdd8d1305777cc8cd206129ea494d6c6ce56001868dd80147aff531d6df0729"
            CACHE="/tmp/${SHA256}.tar.xz"
            test -f "$CACHE" || curl "https://nodejs.org/dist/v6.9.1/node-v6.9.1.tar.xz" -o "$CACHE"
            echo "${SHA256}  $CACHE" | sha256sum -c
            tar -x --strip-components=1 -f "$CACHE"
            ./configure --prefix="$DEST"
            make -j4 all install
        )
        ;;
    cabal|haskell)
        DEST="$PKG_DIR/haskell"
        mkdir "$DEST"
        # Install ghc
        (
            set -e
            cd $(mktemp -d)
            SHA256="b1c06af49b29521d5b122ef3311f5843e342db8b1769ea7c602cc16d66098ced"
            CACHE="/tmp/${SHA256}.tar.xz"
            test -f "$CACHE" || curl "http://downloads.haskell.org/~ghc/8.0.1/ghc-8.0.1-x86_64-deb8-linux.tar.xz" -o "$CACHE"
            echo "${SHA256}  $CACHE" | sha256sum -c
            tar -x --strip-components=1 -f "$CACHE"
            ./configure --prefix="$DEST"
            make -j4 install
        )
        export PATH="$DEST/bin/:$PATH"
        # Install cabal
        (
            set -e
            cd $(mktemp -d)
            SHA256="d840ecfd0a95a96e956b57fb2f3e9c81d9fc160e1fd0ea350b0d37d169d9e87e"
            CACHE="/tmp/${SHA256}.tar.gz"
            test -f "$CACHE" || curl "https://www.haskell.org/cabal/release/cabal-install-1.24.0.0/cabal-install-1.24.0.0.tar.gz" -o "$CACHE"
            echo "${SHA256} $CACHE" | sha256sum -c
            tar -x --strip-components=1 -f "$CACHE"
            ./bootstrap.sh --no-doc
        )
        ;;
    *)
        echo "Pkgs unknown"
        exit 127
esac
